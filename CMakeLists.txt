##
## This program is free software; you can redistribute it and/or modify
## it under the terms of the GNU General Public License as published by
## the Free Software Foundation; either version 3 of the License, or
## any later version.
##
## This program is distributed in the hope that it will be useful,
## but WITHOUT ANY WARRANTY; without even the implied warranty of
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
## GNU General Public License for more details.
##
## You should have received a copy of the GNU General Public License along
## with this program; If not, see <http://www.gnu.org/licenses/>.
##
## Copyright (C) 2016 Martin-Pierrat Louis (louismartinpierrat@gmail.com)
##



## CMAKE INITIALISATION

PROJECT(Engine)
CMAKE_MINIMUM_REQUIRED(VERSION 2.8.12)
SET(CMAKE_MODULE_PATH ${CMAKE_MODULE_PATH} ${CMAKE_SOURCE_DIR}/cmake/)

## END CMAKE INITIALISATION



## PROJECT VERSION

SET(PROJECT_VERSION_MAJOR 2)
SET(PROJECT_VERSION_MINOR 2)
SET(PROJECT_VERSION_PATCH 1)
SET(PROJECT_VERSION_EXTRA 0)

SET(PROJECT_VERSION ${PROJECT_VERSION_MAJOR}.${PROJECT_VERSION_MINOR}.${PROJECT_VERSION_PATCH})
SET(PROJECT_VERSION_FULL ${PROJECT_VERSION}.${PROJECT_VERSION_EXTRA})

## END PROJECT VERSION

## PROJECT CONFIGURATION

SET(PROJECT_INCLUDE_DIR ${CMAKE_SOURCE_DIR}/include/)
SET(PROJECT_SOURCE_DIR ${CMAKE_SOURCE_DIR}/source/)

SET(RESOURCES_PATH ${CMAKE_SOURCE_DIR}/resources)

CONFIGURE_FILE(
    ${PROJECT_INCLUDE_DIR}/Engine/Version.hpp.in
    ${PROJECT_INCLUDE_DIR}/Engine/Version.hpp
    )

CONFIGURE_FILE(
    ${PROJECT_INCLUDE_DIR}/Engine/Configuration.hpp.in
    ${PROJECT_INCLUDE_DIR}/Engine/Configuration.hpp
    )

## END PROJECT CONFIGURATION



## PROJECT LANGUAGE

ENABLE_LANGUAGE(CXX)

## END PROJECT LANGUAGE



## FIND LIBRARY DEPENDENCY

FIND_PACKAGE(OpenGL REQUIRED)
FIND_PACKAGE(GLEW REQUIRED)
#FIND_PACKAGE(Devil REQUIRED)
FIND_PACKAGE(Assimp REQUIRED)
FIND_PACKAGE(Log4cpp REQUIRED)
#FIND_PACKAGE(RapidXml REQUIRED)
FIND_PACKAGE(Threads REQUIRED)
FIND_PACKAGE(glm REQUIRED)

## END FIND LIBRARY DEPENDENCY


## PROJECT SOURCES FILES

FILE(GLOB_RECURSE PROJECT_SOURCE_FILES
    ${PROJECT_SOURCE_DIR}/*.cpp
    )

## END PROJECT SOURCES FILES



## PROJECT HEADERS FILES

SET(GLOB_RECURSE PROJECT_INCLUDE_FILES
    ${PROJECT_INCLUDE_DIR}/*.hpp
    )

## END PROJECT HEADERS FILES



## PROJECT INCLUDES DIRECTORIES

INCLUDE_DIRECTORIES(
    ${PROJECT_INCLUDE_DIR}
    ${OPENGL_INCLUDE_DIR}
    ${GLEW_INCLUDE_DIRS}
    ${ASSIMP_INCLUDE_DIR}
    #${DevIL_INCLUDE_DIR}
    ${LOG4CPP_INCLUDE_DIR}
    ${GLM_INCLUDE_DIRS}
    )

## END PROJECT INCLUDES DIRECTORIES



## PROJECT SETTINGS

IF (CMAKE_BUILD_TYPE MATCHES "debug")

    ADD_DEFINITIONS(-D__DEBUG__)

ELSE ()

    ADD_DEFINITIONS(-D__RELEASE__)

ENDIF ()

## END PROJECT SETTINGS



## COMPILATION SETTINGS

IF (CMAKE_COMPILER_IS_GNUCXX)

    ADD_DEFINITIONS(-Wall -Wextra -std=c++14)

ENDIF()

#if (WIN32)
    #if (MSVC)
    #elseif(CMAKE_COMPILER_IS_GNUCXX)
    ## SET(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -mwindows")
    ## # Not tested
    #else()
    #message(SEND_ERROR "You are using an
    #unsupported Windows compiler! (Not MSVC or GCC)")
    #endif()
#elseif (UNIX)
    #set(CMAKE_PREFIX_PATH "/usr/lib64/qt5")
    #SET(CMAKE_CXX_FLAGS "-std=c++14 -W -Wall -Wextra")
#else ()
    #message(SEND_ERROR "You are on an unsupported platform! (Not Win32 or Unix)")
#ENDIF ()

## END COMPILATION SETTINGS



## BINARY SETTINGS

ADD_LIBRARY(${CMAKE_PROJECT_NAME} SHARED ${PROJECT_SOURCE_FILES})

## END BINARY SETTINGS



## LIBRARY SETTINGS

TARGET_LINK_LIBRARIES(${CMAKE_PROJECT_NAME}
    ${OPENGL_LIBRARIES}
    ${GLEW_LIBRARIES}
    ${ASSIMP_LIBRARY}
    ${LOG4CPP_LIBRARY}
#    ${DevIL_LIBRARY_ILUT}
    #${DevIL_LIBRARY_ILU}
    #${DevIL_LIBRARY_IL}
    )

IF (WIN32)
    TARGET_LINK_LIBRARIES(${CMAKE_PROJECT_NAME} wsock32 ws2_32)
ENDIF()

## END LIBRARY SETTINGS



## INSTALLATION SETTINGS

INSTALL(TARGETS ${CMAKE_PROJECT_NAME}
    RUNTIME DESTINATION bin
    LIBRARY DESTINATION lib
    ARCHIVE DESTINATION lib)

INSTALL(DIRECTORY ${PROJECT_INCLUDE_DIR}
    DESTINATION include
    FILES_MATCHING PATTERN "*.hpp"
    )

## END INSTALLATION SETTINGS


## TEST CONFIGURATION

INCLUDE(ExternalProject)

IF ( MSVC )

    SET(EXTERNAL_PROJECT_CMAKE_ARGS
        -DCMAKE_ARCHIVE_OUTPUT_DIRECTORY_DEBUG:PATH=.
        -DCMAKE_ARCHIVE_OUTPUT_DIRECTORY_RELEASE:PATH=.
        -DCMAKE_ARCHIVE_OUTPUT_DIRECTORY=PATH.
        -DBUILD_GTEST=ON
    )

ELSE ()

    SET(EXTERNAL_PROJECT_CMAKE_ARGS
        -DBUILD_GTEST=ON
    )

ENDIF()

EXTERNALPROJECT_ADD(googletest
    GIT_REPOSITORY https://github.com/google/googletest.git
    CMAKE_ARGS ${EXTERNAL_PROJECT_CMAKE_ARGS}
    PREFIX ${CMAKE_CURRENT_BINARY_DIR}
    INSTALL_COMMAND ""
    )

EXTERNALPROJECT_GET_PROPERTY(googletest source_dir)
SET(GTEST_INCLUDE_DIRS ${source_dir}/googletest/include)

EXTERNALPROJECT_GET_PROPERTY(googletest BINARY_DIR)
SET(GTEST_LIBS_DIR ${BINARY_DIR}/googlemock/gtest/)

INCLUDE_DIRECTORIES(${GTEST_INCLUDE_DIRS})

FUNCTION(CXX_TEST name sources)

    ADD_EXECUTABLE(${name} ${sources})
    ADD_DEPENDENCIES(${name} googletest)
    TARGET_LINK_LIBRARIES(${name}
        ${GTEST_LIBS_DIR}/${CMAKE_FIND_LIBRARY_PREFIXES}gtest${CMAKE_STATIC_LIBRARY_SUFFIX}
        ${GTEST_LIBS_DIR}/${CMAKE_FIND_LIBRARY_PREFIXES}gtest_main${CMAKE_STATIC_LIBRARY_SUFFIX}
        ${CMAKE_PROJECT_NAME}
    )
    TARGET_LINK_LIBRARIES(${name} ${CMAKE_THREAD_LIBS_INIT})
    ADD_TEST(${name} ${name})

ENDFUNCTION()

## END TEST CONFIGURATION



## TESTS

ENABLE_TESTING()

CXX_TEST(test1 test/test1.cpp)
CXX_TEST(test_core test/test_core.cpp)

## END TESTS



## DOXYGEN CONFIGURATION

FIND_PACKAGE(Doxygen QUIET)

IF (DOXYGEN_FOUND)

    CONFIGURE_FILE(
        ${CMAKE_SOURCE_DIR}/Doxyfile.in
        ${CMAKE_BINARY_DIR}/Doxyfile
        @ONLY)

    ADD_CUSTOM_TARGET(doc
        ${DOXYGEN_EXECUTABLE} ${CMAKE_BINARY_DIR}/Doxyfile
        WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}/sources
        COMMENT "Generating API documentation with Doxygen" VERBATIM
        )

ENDIF (DOXYGEN_FOUND)

## END DOXYGEN CONFIGURATION

